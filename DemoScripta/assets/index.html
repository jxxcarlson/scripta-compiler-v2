
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Scripta Live</title>

    <script src="katex.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

    <script defer src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin="anonymous"></script>

<!--    <script-->
<!--            src="https://sdk.feedback.one/v0/core.min.js"-->
<!--            data-project-id="01983ae0-37ff-71b3-8a9a-6e7700e2ebb2"-->
<!--            defer-->
<!--    ></script>-->


    <script src="main.js"></script>

</head>

<body>

<div id="main"></div>

<script>

		var root = document.getElementById('main');
		var app = Elm.Main.init({
		    node: root, 
		    flags: {
		        window: {windowWidth: window.innerWidth, windowHeight: window.innerHeight },
		        currentTime: Date.now()
		    }
		});
        
        // Initialize KaTeX
        init(app);
        
        // Force a re-render after KaTeX is loaded to ensure math elements are rendered
        setTimeout(() => {
            console.log('Forcing re-render after KaTeX load');
            // Trigger a dummy resize event to force Elm to re-render
            window.dispatchEvent(new Event('resize'));
        }, 500);
        
        // Local Storage Management
        const STORAGE_KEY = 'scripta-documents';
        const CURRENT_DOC_KEY = 'scripta-current-document';
        
        // Load all documents from local storage
        app.ports.loadDocuments.subscribe(() => {
            const docsJson = localStorage.getItem(STORAGE_KEY);
            const docs = docsJson ? JSON.parse(docsJson) : [];
            console.log('Loading documents from localStorage:', docs);
            console.log('Number of documents found:', docs.length);
            app.ports.documentsLoaded.send(docs);
            
            // Also check for last opened document
            const currentDocId = localStorage.getItem(CURRENT_DOC_KEY);
            console.log('Last opened document ID:', currentDocId);
            if (currentDocId && docs.length > 0) {
                const currentDoc = docs.find(d => d.id === currentDocId);
                if (currentDoc) {
                    console.log('Restoring document:', currentDoc.title);
                    setTimeout(() => {
                        app.ports.documentLoaded.send(currentDoc);
                    }, 100);
                } else {
                    console.log('Could not find document with ID:', currentDocId);
                }
            }
        });
        
        // Save a document to local storage
        app.ports.saveDocument.subscribe((doc) => {
            const docsJson = localStorage.getItem(STORAGE_KEY);
            let docs = docsJson ? JSON.parse(docsJson) : [];
            
            // Update or add the document
            const existingIndex = docs.findIndex(d => d.id === doc.id);
            if (existingIndex >= 0) {
                docs[existingIndex] = doc;
            } else {
                docs.push(doc);
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
            localStorage.setItem(CURRENT_DOC_KEY, doc.id);
            
            // Send back updated list
            app.ports.documentsLoaded.send(docs);
        });
        
        // Load a specific document
        app.ports.loadDocument.subscribe((id) => {
            const docsJson = localStorage.getItem(STORAGE_KEY);
            const docs = docsJson ? JSON.parse(docsJson) : [];
            const doc = docs.find(d => d.id === id);
            
            if (doc) {
                localStorage.setItem(CURRENT_DOC_KEY, id);
                app.ports.documentLoaded.send(doc);
            }
        });
        
        // Delete a document
        app.ports.deleteDocument.subscribe((id) => {
            const docsJson = localStorage.getItem(STORAGE_KEY);
            let docs = docsJson ? JSON.parse(docsJson) : [];
            
            docs = docs.filter(d => d.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
            
            // Clear current doc if it was deleted
            const currentDocId = localStorage.getItem(CURRENT_DOC_KEY);
            if (currentDocId === id) {
                localStorage.removeItem(CURRENT_DOC_KEY);
            }
            
            // Send back updated list
            app.ports.documentsLoaded.send(docs);
        });
        
        // Debug helper functions - you can run these in the browser console
        window.debugScripta = {
            // Check what's in localStorage
            checkStorage: function() {
                const docs = localStorage.getItem('scripta-documents');
                const currentId = localStorage.getItem('scripta-current-document');
                console.log('=== Scripta Storage Debug ===');
                console.log('Documents in storage:', docs ? JSON.parse(docs) : 'No documents found');
                console.log('Current document ID:', currentId || 'None');
                console.log('===========================');
                return docs ? JSON.parse(docs) : null;
            },
            
            // List all localStorage keys
            listAllKeys: function() {
                console.log('=== All localStorage keys ===');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    console.log(key, ':', localStorage.getItem(key).substring(0, 100) + '...');
                }
                console.log('===========================');
            },
            
            // Manually restore a document by ID
            restoreDocument: function(docId) {
                const docs = localStorage.getItem('scripta-documents');
                if (docs) {
                    const parsed = JSON.parse(docs);
                    const doc = parsed.find(d => d.id === docId);
                    if (doc) {
                        app.ports.documentLoaded.send(doc);
                        console.log('Document restored:', doc.title);
                    } else {
                        console.log('Document not found with ID:', docId);
                    }
                } else {
                    console.log('No documents in storage');
                }
            }
        };

</script>

</body>
</html>