<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripta Desktop</title>

    <!-- Feedback.one widget -->
    <script
        src="https://sdk.feedback.one/v0/core.min.js"
        data-project-id="01995ed7-6ce2-73e1-afba-661ca193a2c4"
        defer
    ></script>

    <!-- Load the actual KaTeX library first -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    
    <!-- Then load the custom element wrapper -->
    <script src="katex.js"></script>
    
    <!-- CodeMirror editor custom element -->
    <script src="codemirror-element.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- Elm application -->
    <script src="main-tauri.js?v=2"></script>
    <script>
        // Global error handler to catch crashes
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error);
            console.error('Stack:', event.error.stack);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Wrap everything in an IIFE to allow early returns
        (function() {
        // Initialize Elm app
        const app = Elm.MainTauri.init({
            node: document.getElementById('app'),
            flags: {
                window: {
                    windowWidth: window.innerWidth,
                    windowHeight: window.innerHeight
                },
                currentTime: Date.now(),
                theme: null // Will be loaded from SQLite
            }
        });
        
        console.log('Elm app initialized successfully');
        
        // Debug: Check what's happening after init
        setTimeout(() => {
            console.log('=== Debug Check after 2 seconds ===');
            const editors = document.querySelectorAll('codemirror-editor');
            console.log('Number of codemirror-editor elements:', editors.length);
            editors.forEach((editor, index) => {
                console.log(`Editor ${index}:`, {
                    hasLoadAttribute: editor.hasAttribute('load'),
                    loadValue: editor.getAttribute('load'),
                    textValue: editor.getAttribute('text'),
                    editorValue: editor.editorValue
                });
            });
        }, 2000);
        
        // Wait for Tauri API to be ready
        function waitForTauri(callback, attempts = 0) {
            if (window.__TAURI__) {
                callback();
            } else if (attempts < 10) {
                console.log('Waiting for Tauri API... attempt', attempts + 1);
                setTimeout(() => waitForTauri(callback, attempts + 1), 100);
            } else {
                console.error('TAURI API NOT AVAILABLE after 10 attempts!');
                alert('Failed to initialize Tauri API. Please restart the application.');
            }
        }
        
        waitForTauri(function() {
            console.log('Tauri API is ready!');
            console.log('Tauri structure:', window.__TAURI__);
            
            // For Tauri 2.0, we need to use the core module
            let invoke;
            try {
                // Try Tauri 2.0 structure first
                if (window.__TAURI__.core && window.__TAURI__.core.invoke) {
                    invoke = window.__TAURI__.core.invoke;
                    console.log('Using Tauri 2.0 core.invoke');
                } else if (window.__TAURI__.invoke) {
                    invoke = window.__TAURI__.invoke;
                    console.log('Using Tauri invoke directly');
                } else if (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke) {
                    invoke = window.__TAURI__.tauri.invoke;
                    console.log('Using Tauri 1.x tauri.invoke');
                } else {
                    console.error('invoke function not found in Tauri API');
                    console.error('Available properties:', Object.keys(window.__TAURI__));
                    return;
                }
            } catch (e) {
                console.error('Error accessing Tauri API:', e);
                return;
            }
        
        // Test Tauri connection immediately
        console.log('Testing Tauri connection...');
        invoke('handle_tauri_command', { payload: { cmd: 'initDatabase' } })
            .then(result => console.log('Initial Tauri test successful:', result))
            .catch(err => console.error('Initial Tauri test failed:', err));
        
        // Check if ports exist
        if (!app.ports.tauriCommand) {
            console.error('ERROR: tauriCommand port not found!');
            console.log('Available ports:', Object.keys(app.ports));
        }
        if (!app.ports.tauriResult) {
            console.error('ERROR: tauriResult port not found!');
        }
        
        // Handle Tauri commands from Elm
        if (app.ports.tauriCommand) {
            app.ports.tauriCommand.subscribe(async (command) => {
                console.log('Tauri command:', command);
            
            try {
                const result = await invoke('handle_tauri_command', { payload: command });
                console.log('Tauri result:', result);
                
                // Special handling for different result types
                if (result.type === 'databaseInitialized') {
                    console.log('Database initialized, should now list documents');
                } else if (result.type === 'documentsListed') {
                    console.log('Documents listed:', result.documents);
                    console.log('Number of documents:', result.documents ? result.documents.length : 0);
                } else if (result.type === 'documentLoaded') {
                    console.log('Document loaded:', result.document);
                    if (result.document) {
                        console.log('Document details:', {
                            id: result.document.id,
                            title: result.document.title,
                            theme: result.document.theme,
                            contentLength: result.document.content ? result.document.content.length : 0,
                            contentPreview: result.document.content ? result.document.content.substring(0, 100) + '...' : 'No content'
                        });
                    }
                } else if (result.type === 'userNameLoaded') {
                    console.log('Username loaded:', result.userName);
                }
                app.ports.tauriResult.send(result);
            } catch (error) {
                console.error('Tauri error:', error);
                app.ports.tauriResult.send({
                    type: command.cmd + 'Error',
                    error: error.toString()
                });
            }
            });
        } else {
            console.error('Cannot subscribe to tauriCommand - port not found');
        }
        
        // Initialize KaTeX
        if (typeof initKatex === 'function') {
            initKatex();
            console.log('KaTeX custom elements initialized');
        } else {
            console.error('initKatex function not found!');
        }
        
        // Check if KaTeX library is loaded
        if (typeof katex !== 'undefined') {
            console.log('KaTeX library is loaded');
        } else {
            console.error('KaTeX library not found! Math rendering will not work.');
        }
        
        // Force a re-render after KaTeX is loaded to ensure math elements are rendered
        setTimeout(() => {
            console.log('Forcing re-render after KaTeX load');
            // Trigger a dummy resize event to force Elm to re-render
            window.dispatchEvent(new Event('resize'));
        }, 500);
        
        // Initialize CodeMirror after a delay to ensure DOM is ready
        setTimeout(() => {
            console.log('Initializing CodeMirror...');
            if (typeof initCodeMirror === 'function') {
                try {
                    initCodeMirror();
                    console.log('CodeMirror initialized');
                    
                    // Add error handling for CodeMirror events
                    document.addEventListener('text-change', function(event) {
                        console.log('text-change event:', event.detail);
                    });
                    
                    document.addEventListener('selected-text', function(event) {
                        console.log('selected-text event:', event.detail);
                    });
                    
                    // Verify the editor element exists
                    setTimeout(() => {
                        const editorElement = document.getElementById('editor-here');
                        if (editorElement) {
                            console.log('Editor container found:', editorElement);
                            // Check if CodeMirror instance exists
                            const cmEditors = document.querySelectorAll('codemirror-editor');
                            console.log('CodeMirror editors found:', cmEditors.length);
                            cmEditors.forEach((editor, index) => {
                                console.log(`Editor ${index}:`, editor);
                                console.log(`Editor ${index} value:`, editor.editorValue);
                            });
                        } else {
                            console.error('Editor container #editor-here not found!');
                        }
                    }, 1000)
                } catch (error) {
                    console.error('Error initializing CodeMirror:', error);
                }
            } else {
                console.error('initCodeMirror function not found!');
            }
        }, 500); // Give Elm time to render
        }); // End waitForTauri callback
        })(); // End IIFE
    </script>
</body>
</html>