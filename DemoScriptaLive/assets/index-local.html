
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripta Live</title>
    
    <!-- Load the actual KaTeX library first -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    
    <!-- Then load the custom element wrapper -->
    <script src="katex.js"></script>
    
    <!-- CodeMirror editor custom element -->
    <script src="codemirror-element.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- Elm application -->
    <script src="main-local.js"></script>
    <script>
        const app = Elm.MainLocal.init({
            node: document.getElementById('app'),
            flags: {
                window: {
                    windowWidth: window.innerWidth,
                    windowHeight: window.innerHeight
                },
                currentTime: Date.now(),
                theme: localStorage.getItem('theme')
            }
        });
        
        // Handle localStorage operations
        app.ports.outgoing.subscribe((message) => {
            console.log('Port message:', message);
            
            switch (message.tag) {
                case 'SaveDocument':
                    const doc = message.data;
                    // Save to localStorage
                    const documents = JSON.parse(localStorage.getItem('documents') || '{}');
                    documents[doc.id] = doc;
                    localStorage.setItem('documents', JSON.stringify(documents));
                    
                    // Send confirmation back
                    app.ports.incoming.send({
                        tag: 'DocumentsLoaded',
                        data: Object.values(documents)
                    });
                    break;
                    
                case 'LoadDocuments':
                    const loadedDocs = JSON.parse(localStorage.getItem('documents') || '{}');
                    app.ports.incoming.send({
                        tag: 'DocumentsLoaded',
                        data: Object.values(loadedDocs)
                    });
                    break;
                    
                case 'LoadDocument':
                    const allDocs = JSON.parse(localStorage.getItem('documents') || '{}');
                    const loadedDoc = allDocs[message.data];
                    if (loadedDoc) {
                        app.ports.incoming.send({
                            tag: 'DocumentLoaded',
                            data: loadedDoc
                        });
                    }
                    break;
                    
                case 'DeleteDocument':
                    const docsToUpdate = JSON.parse(localStorage.getItem('documents') || '{}');
                    delete docsToUpdate[message.data];
                    localStorage.setItem('documents', JSON.stringify(docsToUpdate));
                    
                    // Send updated list back
                    app.ports.incoming.send({
                        tag: 'DocumentsLoaded',
                        data: Object.values(docsToUpdate)
                    });
                    break;
                    
                case 'SaveTheme':
                    localStorage.setItem('theme', message.data);
                    break;
                    
                case 'LoadTheme':
                    const theme = localStorage.getItem('theme') || 'light';
                    app.ports.incoming.send({
                        tag: 'ThemeLoaded',
                        data: theme
                    });
                    break;
                    
                case 'SaveUserName':
                    localStorage.setItem('userName', message.data);
                    break;
                    
                case 'LoadUserName':
                    const userName = localStorage.getItem('userName') || '';
                    app.ports.incoming.send({
                        tag: 'UserNameLoaded',
                        data: userName
                    });
                    break;
                    
                case 'SaveLastDocumentId':
                    localStorage.setItem('lastDocumentId', message.data);
                    break;
                    
                case 'LoadLastDocumentId':
                    const lastDocumentId = localStorage.getItem('lastDocumentId') || '';
                    app.ports.incoming.send({
                        tag: 'LastDocumentIdLoaded',
                        data: lastDocumentId
                    });
                    break;
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            // Resize is handled through Browser.Events.onResize in Elm
        });
        
        // Initialize with stored theme
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
            app.ports.incoming.send({
                tag: 'ThemeLoaded',
                data: storedTheme
            });
        }
        
        // Initialize KaTeX
        if (typeof initKatex === 'function') {
            initKatex();
            console.log('KaTeX custom elements initialized');
        } else {
            console.error('initKatex function not found!');
        }
        
        // Check if KaTeX library is loaded
        if (typeof katex !== 'undefined') {
            console.log('KaTeX library is loaded');
        } else {
            console.log('Waiting for KaTeX library to load...');
        }
        
        // Initialize CodeMirror after a delay to ensure DOM is ready
        setTimeout(() => {
            console.log('Initializing CodeMirror...');
            if (typeof initCodeMirror === 'function') {
                initCodeMirror();
                console.log('CodeMirror initialized');
                
                // Verify the editor element exists
                const editorElement = document.getElementById('editor-here');
                if (editorElement) {
                    console.log('Editor container found:', editorElement);
                } else {
                    console.error('Editor container #editor-here not found!');
                }
            } else {
                console.error('initCodeMirror function not found!');
            }
        }, 500); // Give Elm time to render
    </script>
</body>
</html>